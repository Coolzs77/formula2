# 手写数学公式识别系统使用说明

## 1. 项目概述

本项目是一个基于深度学习的手写数学公式识别系统，能够识别手写的数字和数学符号，并进行公式识别和计算。系统使用卷积神经网络模型，通过MNIST数据集和自动生成的数学符号数据集进行训练。

## 2. 系统要求

- Python 3.6+ (推荐Python 3.8或更高版本)
- CUDA支持(可选，用于GPU加速)
- 约2GB磁盘空间(用于存储数据集和模型)

## 3. 安装步骤

### 3.1 安装依赖库

```bash
pip install -r requirements.txt
```

主要依赖库包括：
- torch
- torchvision
- numpy
- opencv-python (cv2)
- matplotlib
- Pillow
- sympy (用于公式计算)
- tqdm

### 3.2 目录结构确认

确保项目目录结构如下：

```
formula/
├── data/
│   └── mnist/               # MNIST数据集(自动下载)
│   └── math_symbols/        # 生成的数学符号数据
├── model/                   # 存放训练的模型
├── src/
│   ├── data/
│   │   ├── dataset.py       # 数据集加载处理
│   │   ├── generator.py     # 数学符号生成器
│   │   └── preprocessing.py # 图像预处理功能
│   ├── models/
│   │   ├── config.py        # 模型配置
│   │   └── symbol_recognizer.py # 符号识别模型
│   ├── recognition/
│   │   └── formula.py       # 公式识别逻辑
│   └── ui/
│       ├── app.py           # 主应用界面
│       └── canvas.py        # 画布处理函数
├── scripts/
│   ├── generate_symbols.py  # 符号生成脚本
│   └── train.py             # 训练脚本
└── main.py                  # 主程序入口
```

## 4. 使用流程

### 4.1 生成数学符号数据集

首次使用前，需要生成数学符号数据集：

```bash
python main.py --generate_symbols
```

这将在`data/math_symbols/`目录下生成数学符号数据集，每个符号生成1000个样本。你也可以通过脚本直接控制：

```bash
python scripts/generate_symbols.py --samples 2000 --output ./data/my_symbols
```

### 4.2 训练模型

训练识别模型：

```bash
python main.py --train --epochs 15 --batch_size 64
```

训练参数可以根据需要调整：
- `--epochs`: 训练轮数，默认15轮
- `--batch_size`: 批次大小，默认64

训练后，模型将保存在`model/`目录下：
- `best_symbol_model.pth`: 验证集上表现最佳的模型
- `symbol_model.pth`: 最终模型

### 4.3 启动图形界面

```bash
python main.py
```

不带参数启动程序会默认进入图形用户界面模式。

## 5. 图形界面使用说明

![界面概览](界面示意图.png)

界面分为左右两部分：
- 左侧：画布区域和图像显示区
- 右侧：操作按钮和识别结果显示

### 5.1 手写输入识别

1. 在左侧画布上使用鼠标手写数学公式
2. 点击"识别公式"按钮
3. 查看右侧识别结果

### 5.2 图像文件识别

1. 点击"加载图像"按钮
2. 选择包含手写公式的图像文件(.png, .jpg, .jpeg, .bmp)
3. 点击"识别公式"按钮
4. 查看识别结果

### 5.3 清除画布

点击"清除画布"按钮可清除当前画布内容。

### 5.4 识别结果

识别结果区域显示三部分内容：
- 识别公式：系统识别出的公式字符串
- LaTeX：公式的LaTeX表示形式
- 计算结果：如果公式可计算，显示计算结果

## 6. 命令行参数说明

```
usage: main.py [-h] [--train] [--ui] [--epochs EPOCHS] [--batch_size BATCH_SIZE] [--generate_symbols]

手写数学公式识别系统

optional arguments:
  -h, --help            显示帮助信息并退出
  --train               训练新模型
  --ui                  启动图形用户界面
  --epochs EPOCHS       训练轮数
  --batch_size BATCH_SIZE
                        训练批次大小
  --generate_symbols    仅生成数学符号数据集
```

## 7. 支持的符号

当前版本支持以下符号识别：

| 类别 | 符号 | 说明 |
|------|------|------|
| 0-9 | 0-9 | 数字 |
| 10 | + | 加号 |
| 11 | - | 减号 |
| 12 | × | 乘号 |
| 13 | ÷ | 除号 |
| 14 | = | 等号 |
| 15 | ( | 左括号 |
| 16 | ) | 右括号 |
| 17 | x | 变量x |
| 18 | y | 变量y |
| 19 | ^ | 指数符号 |
| 20 | √ | 平方根 |
| 21 | π | 圆周率 |
| 22 | ! | 阶乘 |
| 23 | % | 百分号 |
| 24 | . | 小数点 |

## 8. 常见问题解决

### 8.1 模型加载失败

错误信息：`未找到模型文件。请先训练模型或检查模型路径`

解决方案：
- 确认已经运行过训练命令`python main.py --train`
- 检查`model/`目录下是否存在`.pth`模型文件

### 8.2 图像识别不准确

问题：手写识别结果不准确

解决方案：
- 尝试书写更加清晰、规范的符号
- 确保符号间距适当
- 可以增加训练数据和训练轮数提高准确率

### 8.3 CUDA相关错误

错误信息：与CUDA相关的错误

解决方案：
- 如果没有CUDA支持，系统会自动使用CPU
- 检查CUDA和PyTorch版本兼容性
- 尝试使用`export CUDA_VISIBLE_DEVICES=-1`强制使用CPU

### 8.4 无法计算公式结果

问题：识别出公式但显示"无法计算"

解决方案：
- 确认已安装sympy库: `pip install sympy`
- 公式必须是完整有效的数学表达式
- 部分复杂公式可能超出系统计算能力

## 9. 训练自己的模型

如需针对特定类型的手写风格进行优化，可以：

1. 准备自己的手写样本数据集
2. 调整`src/models/config.py`中的符号配置
3. 修改`train.py`中的训练参数
4. 重新训练模型

```bash
python scripts/train.py --epochs 30 --batch_size 32 --lr 0.0005
```

## 10. 项目扩展

未来可能的扩展方向：
- 添加更多数学符号支持
- 优化整体公式结构识别
- 添加导出识别结果为LaTeX文档功能
- 移动端应用支持